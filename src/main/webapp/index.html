<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Catch a Ride Go!</title>

	<style>
      /* Always set the map height explicitly to define the size of the div
      * element that contains the map. */
      #map {
      	height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
      	height: 100%;
      	margin: 0;
      	padding: 0;
      }

      .logo-overlay {
      	position:absolute;
      	top: 30px;
      	left: 5px;
      	background-image: url("images/catch-a-ride.png");
      	height: 60px;
      	width: 468px;
      	z-index: 200;
      }
      .attribution {
      	position: absolute;
      	bottom: 25px;
      	left: 5px;
      	height: 10px;
      	width: 90%;
      	z-index: 200;
      	font-size: 8px;
      }
  </style>
</head>
<body id="container">
	<div class="logo-overlay"></div>
	<div id="map"></div>
	<div class="attribution">Icons made by <a href="http://www.flaticon.com/authors/scott-de-jonge" title="Scott de Jonge">Scott de Jonge</a> from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a> is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0" target="_blank">CC 3.0 BY</a></div>

	<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD2yMJAeJ7ZX_xYdgchCyXHEvcdHEuTJcc&libraries=geometry,places"></script>
	<script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
	<script src="https://code.jquery.com/jquery-3.1.1.min.js"   integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="   crossorigin="anonymous"></script>
	<script>
		$( window ).ready(function() {
		var token;
		$.get("rest/token", function( data ) {
			token = data;
			console.log('token defined: ' + token);
		});


		//////////////////////////////////
		/// GEO LOCATION THINGS
		var container = document.getElementById("container");
		var map, myMarker, markers;

		myMarker = new google.maps.Marker({
			label: 'Me!',
			icon: walkImage,
		});

		/**
		 * Google image icon for walking person
		 * @type {Object}
		 */
		var walkImage = {
			url:'images/pedestrian-walking.png',
			size: new google.maps.Size(20,32),
			origin: new google.maps.Point(0,0),
			anchor: new google.maps.Point(0,32)
		};

		/**
		 * Google image icon for bus, should be car later
		 * @type {Object}
		 */
		var busImage = {
			url:'images/frontal-bus-silhouette.png',
			size: new google.maps.Size(32,32),
			origin: new google.maps.Point(0,0),
			anchor: new google.maps.Point(0,32)
		};

		/**
		 * Geo-location options for increased accuracy
		 * @type {Object}
		 */
		var geoOptions = {
			enableHighAccuracy: true,
			maximumAge: 30000,
			timeout: 27000,
		};

		function updateMyLocation(latitude, longitude, accuracy) {
			if (myMarker && latitude && longitude) {
				console.log("<"+latitude+","+longitude+">");
				myMarker.setPosition(new google.maps.LatLng(latitude, longitude));
			}
			if (token) {
				var payload = {};
				payload.latitude = latitude;
				payload.longitude = longitude;
				payload.accuracy = accuracy;
				payload.id = token;
				payload.message = 'from browser';

				$.ajax({
					url: 'rest/location',
					type: 'post',
					dataType: 'json',
					contentType: 'application/json',
					data: JSON.stringify(payload),
					success: function( data, textStatus, jQxhr) {
						console.log(data);
					},
					error: function( jqXhr, textStatus, errorThrown) {
						console.log( errorThrown );
					}
				});
			}
		}

		function updateLocations() {
			if (token) {
				$.get("rest/locations", function( data ) {
					console.log('locations prior to this browser submits data to server');
					console.log(JSON.stringify(data,null,' '));
					updateMarkers(data);
				});
			}
			else {
				console.log("missing token");
			}
		}

		function updateMarkers(data) {
			console.log("updating locations");
			// longitude, latitude, id
			for (var i in data) {
				var markerFound = false;
				for (var j in markers) {
					if (markers[j].id == data[i].id) {
						markers[j].setPosition(new google.maps.LatLng(data[i].latitude, data[i].longitude));
						markerFound = true;
					}
				}
				if (!markerFound) {
					// add new marker
					new google.maps.Marker({
						position: new google.maps.LatLng(data[i].latitude, data[i].longitude),
						map: map,
					});
				}
			}
		}


		/**
		 * Initialize Google Map variables and populate object
		 * @return {None}
		 */
		function initMap() {

			map = new google.maps.Map(document.getElementById('map'), {
				zoom: 15,
				center: {lat: 41.340485, lng: -72.0991807}
			});
			var infoWindow = new google.maps.InfoWindow({map: map});

			// Try HTML5 geolocation.
			if (navigator.geolocation) {
				navigator.geolocation.watchPosition(function(position) {
					var pos = {
						lat: position.coords.latitude,
						lng: position.coords.longitude
					};

					map.setCenter(pos);
					updateLocations();
					updateMyLocation(pos.lat, pos.lng);
				}, function() {
					handleLocationError(true, infoWindow, map.getCenter());
				});
			}
			else {
				// Browser doesn't support Geolocation
				handleLocationError(false, infoWindow, map.getCenter());
			}

	        // locations = setLocations();

	        // Add some markers to the map.
	        // markers = locations.map(function(location, i) {
	        // 	return new google.maps.Marker({
	        // 		position: {lat: location.lat, lng: location.lng},
	        // 		label: location.label,
	        // 		icon: busImage,
	        // 		id: i,
	        // 	});
	        // });
	        markers = [];
	        markers.push(myMarker);

	        // Add a marker clusterer to manage the markers.
	        var markerCluster = new MarkerClusterer(map, markers,
	        	{imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});
	    }

	    initMap();
	});
	</script>
</body>
</html>