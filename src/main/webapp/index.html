<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="initial-scale=1.0">
	<title>Catch a Ride Go!</title>

	<style>
      /* Always set the map height explicitly to define the size of the div
      * element that contains the map. */
      #map {
      	height: 100%;
      	width: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
      	height: 100%;
      	width: 100%;
      	margin: 0;
      	padding: 0;
      }

      .logo-overlay {
      	position:absolute;
      	top: 30px;
      	left: 5px;
      	background-image: url("images/catch-a-ride.png");
      	height: 60px;
      	width: 468px;
      	z-index: 200;
      }
      .attribution {
      	position: absolute;
      	bottom: 25px;
      	left: 5px;
      	height: 10px;
      	width: 90%;
      	z-index: 200;
      	font-size: 8px;
      }
  </style>
</head>
<body id="container">
	<div class="logo-overlay"></div>
	<div id="map"></div>
	<div class="attribution">Icons made by <a href="http://www.flaticon.com/authors/scott-de-jonge" title="Scott de Jonge">Scott de Jonge</a> from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a> is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0" target="_blank">CC 3.0 BY</a></div>

	<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD2yMJAeJ7ZX_xYdgchCyXHEvcdHEuTJcc&libraries=geometry,places"></script>
	<script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
	<script src="https://code.jquery.com/jquery-3.1.1.min.js"   integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="   crossorigin="anonymous"></script>
	<script>
		var token;

		$( window ).ready(function() {

		$.get("https://gotta-catch-a-ride-go.mybluemix.net/rest/token", function( data ) {
			token = data;
			if (myMarker) {
				myMarker.id = token;
			}
			console.log('token defined: ' + token);
		});

		//////////////////////////////////
		/// GEO LOCATION THINGS
		var container = document.getElementById("container");
		var map, myMarker, markers;

		myMarker = new google.maps.Marker({
			label: 'Me!',
			icon: walkImage,
			id: token,
		});

		/**
		 * Google image icon for walking person
		 * @type {Object}
		 */
		var walkImage = {
			url:'images/pedestrian-walking.png',
			size: new google.maps.Size(20,32),
			origin: new google.maps.Point(0,0),
			anchor: new google.maps.Point(0,32)
		};

		/**
		 * Google image icon for bus, should be car later
		 * @type {Object}
		 */
		var busImage = {
			url:'images/frontal-bus-silhouette.png',
			size: new google.maps.Size(32,32),
			origin: new google.maps.Point(0,0),
			anchor: new google.maps.Point(0,32)
		};

		/**
		 * Geo-location options for increased accuracy
		 * @type {Object}
		 */
		var geoOptions = {
			enableHighAccuracy: true,
			maximumAge: 30000,
			timeout: 27000,
		};

		/**
		 * Update marker location and update location on server
		 * @param  {float} latitude
		 * @param  {float} longitude
		 * @param  {float} accuracy  value
		 * @return {None}
		 */
		function updateMyLocation(myMarker, latitude, longitude, accuracy) {
			if (myMarker && latitude && longitude) {
				console.log("<"+latitude+","+longitude+">");
				myMarker.setPosition(new google.maps.LatLng(latitude, longitude));
			}
			if (token) {
				var payload = {};
				payload.latitude = latitude;
				payload.longitude = longitude;
				payload.accuracy = accuracy;
				payload.id = token;
				payload.message = 'from browser';

				$.ajax({
					url: 'https://gotta-catch-a-ride-go.mybluemix.net/rest/location',
					type: 'post',
					dataType: 'json',
					contentType: 'application/json',
					success: function( data, textStatus, jQxhr) {
						console.log('update location: <'+payload.latitude+','+payload.longitude+'>');
					},
					error: function( jqXhr, textStatus, errorThrown) {
						console.log( errorThrown );
					}
				});
			}
			else {
				console.log("token undefined for update location");
			}
		}

		/**
		 * Request newest locations from server and update markers
		 * @param  {Integer} token   value to designate unique key
		 * @param  {List} markers list
		 * @param  {Google Map} map
		 * @return {None}
		 */
		function updateLocations(markers, map) {
			if (token) {
				$.get("https://gotta-catch-a-ride-go.mybluemix.net/rest/locations", function( data ) {
					console.log('request latest locations');
					markers = updateMarkers(data, markers, map);
				});
			}
			else {
				console.log("missing token");
			}
		}

		/**
		 * Update existing markers with new data
		 * @param  {Object} data contains new lat, long locations from server or otherwise
		 * @param  {Object} markers contains existing lat, long locations
		 * @param {Google Map}	map existing map object to append markers on
		 * @return {List}      updated list of markers
		 */
		function updateMarkers(data, old_markers, map) {
			console.log("updating locations");
			// longitude, latitude, id
			var marker = [];
			var markerFound = false;

			// remove old values from the map
			for (var k in old_markers) {
				markerFound = false;
				for(var l in data) {
					if (data[l].id == old_markers[k].id) {
						markerFound = true;
						break;
					}
				}
				if (markerFound) {
					markers.push(old_marker[k]);
				}
				else if (!markerFound && old_markers[k].id != myMarker.id) {
					// remove from map and naturally drop by not adding
					old_markers[k].setMap(null);
				}
			}

			// update positions of remaining
			for (var i in data) {
				markerFound = false;
				for (var j in old_markers) {
					if (markers[j].id == data[i].id && markers[i] != myMarker.id) {
						markers[j].setPosition(new google.maps.LatLng(data[i].latitude, data[i].longitude));
						markerFound = true;
						break;
					}
				}
				if (!markerFound) {
					// add new marker
					new google.maps.Marker({
						position: new google.maps.LatLng(data[i].latitude, data[i].longitude),
						map: map,
					});
				}
			}

			return markers;
		}


		/**
		 * Initialize Google Map variables and populate object
		 * @return {None}
		 */
		function initMap() {
			var centered = false;
			map = new google.maps.Map(document.getElementById('map'), {
				zoom: 15,
				center: {lat: 41.340485, lng: -72.0991807}
			});

			// Try HTML5 geolocation.
			if (navigator.geolocation) {
				navigator.geolocation.watchPosition(function(position) {
					var pos = {
						lat: position.coords.latitude,
						lng: position.coords.longitude
					};
					if (!centered) {
						// only do this on initial
						map.setCenter(pos);
						centered = true;
					}
					updateLocations(markers, map);
					updateMyLocation(myMarker, pos.lat, pos.lng);
				}, function() {
					handleLocationError(true, map.getCenter());
				}, geoOptions);
			}
			else {
				// Browser doesn't support Geolocation
				handleLocationError(false, map.getCenter());
			}

			function handleLocationError(navigatorAvail, mapCenter) {
				var infoWindow = new google.maps.InfoWindow({map: map});

			}

	        markers = [];
	        markers.push(myMarker);

	        // Add a marker clusterer to manage the markers.
	        var markerCluster = new MarkerClusterer(map, markers,
	        	{imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});
	    }

	    initMap();

	    window.setInterval(function() {
			console.log('getting and updating locations');
			updateLocations(markers, map);
		}, 6000);
	});
	</script>
</body>
</html>